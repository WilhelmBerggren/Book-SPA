!function(t){var e={};function n(i){if(e[i])return e[i].exports;var o=e[i]={i:i,l:!1,exports:{}};return t[i].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(i,o,function(e){return t[e]}.bind(null,o));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=0)}([function(t,e,n){"use strict";n.r(e);var i=function(t,e,n,i){return new(n||(n=Promise))((function(o,r){function s(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))};class o{constructor(t){this.resourceManager=t,this.books=[],this.getBooks()}getBooks(){return i(this,void 0,void 0,(function*(){return yield this.resourceManager.getBooks().then(t=>(this.books=t,t))}))}}var r=function(t,e,n,i){return new(n||(n=Promise))((function(o,r){function s(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))};class s{constructor(t){this.op="insert",this.id="",this.title="",this.author="",this.resourceManager=t}submitForm(t){return r(this,void 0,void 0,(function*(){return yield this.resourceManager.submitForm(t)}))}}class a{constructor(t){this.resourceManager=t,this.attempts=[]}addAttempt(t){t?this.attempts.push(t):this.attempts.push("Error: undefined attempt")}getAttempts(){return this.resourceManager.attempts}}var c=function(t,e,n,i){return new(n||(n=Promise))((function(o,r){function s(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))};class u{constructor(t){this.key="",this.resourceManager=t}getKey(){return c(this,void 0,void 0,(function*(){return yield this.resourceManager.getKey().then(t=>(this.key=t,t))}))}}var d=function(t,e,n,i){return new(n||(n=Promise))((function(o,r){function s(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))};class l{constructor(){this.listeners=[],this.attempts=[],this.key="",this.getKey()}notify(){return d(this,void 0,void 0,(function*(){this.listeners.forEach(t=>{console.log("Alerting listener: ",t),t.update()})}))}addListener(t){return d(this,void 0,void 0,(function*(){this.listeners.push(t)}))}getBooks(){return d(this,void 0,void 0,(function*(){return yield this.persistentFetch("getBooks",{op:"select",key:yield this.getKey()}).then(t=>t.data)}))}persistentFetch(t,e,n=!1){return d(this,void 0,void 0,(function*(){let i=new URL("https://www.forverkliga.se/JavaScript/api/crud.php");1==n?i.searchParams.append("requestKey","true"):(e.op&&i.searchParams.append("op",e.op),e.id&&i.searchParams.append("id",e.id),e.title&&i.searchParams.append("title",e.title),e.author&&i.searchParams.append("author",e.author),e.key&&i.searchParams.append("key",e.key));let o=0;for(;o<10;){o++;let e=yield fetch(i.toString()).then(t=>t.json());if("success"==e.status)return this.attempts.push(`${t}: Fetched in ${10-o} tries`),this.notify(),e}return this.attempts.push(`${t}: Failed to fetch`),this.notify(),new Response}))}getKey(){return d(this,void 0,void 0,(function*(){return null==window.localStorage.getItem("key")?(this.key=yield this.refreshKey(),this.key):window.localStorage.getItem("key")}))}refreshKey(){return d(this,void 0,void 0,(function*(){return yield this.persistentFetch("getKey",null,!0).then(t=>(window.localStorage.setItem("key",t),this.notify(),t.key))}))}submitForm(t){return d(this,void 0,void 0,(function*(){return t.key=yield this.getKey(),yield this.persistentFetch("submitForm",t)}))}}var h=function(t,e,n,i){return new(n||(n=Promise))((function(o,r){function s(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))};class f{constructor(t){this.model=t,this.filter=""}display(){return h(this,void 0,void 0,(function*(){return console.log("BookView Updating to: ",this.model.books),`\n        <div class="cards">\n            <div class="card">\n                <h1> Books </h1>\n                <input type="text" id="filter" placeholder="filter" value="${this.filter}"">\n                <button id="refresh-books">Refresh</button>\n                <div class="cards">\n                    ${this.filterBooks(this.filter).map(t=>`     \n                        <div class='card'>\n                            <p>Title: ${t.title}</p>\n                            <p>Author: ${t.author}</p>\n                            <p>ID: ${t.id}</p>\n                            <p>Updated: ${t.updated}</p>\n                        </div>\n                        `).join("")}\n                </div>\n            </div>\n        </div>\n        `}))}filterBooks(t){console.log("BookView Filtering: ",t);let e=[];return this.model.books&&this.model.books.forEach(n=>{[n.id,n.title,n.author,n.updated].some(e=>(""+e).includes(t))&&e.push(n)}),e}}var p=function(t,e,n,i){return new(n||(n=Promise))((function(o,r){function s(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))};class v{constructor(t){this.model=t}display(){return p(this,void 0,void 0,(function*(){return`\n            <h1> Form </h1>\n            <form id="bookForm" class="card">\n            <div class="row">\n                <h3> Action </h3>\n                <select name="op" id="op">\n                    <option value="insert" ${"insert"==this.model.op?"selected":""}>Insert</option>\n                    <option value="update" ${"update"==this.model.op?"selected":""}>Update</option>\n                    <option value="delete" ${"delete"==this.model.op?"selected":""}>Delete</option>\n                </select>\n            </div>\n            ${"update"==this.model.op||"delete"==this.model.op?`\n                <div class="row" id="id-row">\n                    <h3> ID </h3>\n                    <input id="id" type="text" name="id" placeholder="id" value="${this.model.id}">\n                </div>\n            `:""}\n            ${"insert"==this.model.op||"update"==this.model.op?`\n                <div class="row" id="author-row">\n                    <h3> Author </h3>\n                    <input id="author" type="text" name="author" placeholder="author" value="${this.model.author}">\n                </div>\n                <div class="row" id="title-row">\n                    <h3> Title </h3>\n                    <input id="title" type="text" name="title" placeholder="title" value="${this.model.title}">\n                </div>\n            `:""}\n            <div class="row">\n                <h3> Submit </h3>\n                <input type="submit">\n            </div>\n        </form>\n        `}))}}var y=function(t,e,n,i){return new(n||(n=Promise))((function(o,r){function s(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))};class m{constructor(t){this.model=t}display(){return y(this,void 0,void 0,(function*(){return`\n            <h1> Submission Attempts </h1>\n            <p id="attempts"></p>\n            ${this.model.getAttempts().map(t=>`\n                <p>${t}</p>\n            `).join("")}\n        `}))}}var w=function(t,e,n,i){return new(n||(n=Promise))((function(o,r){function s(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))};class g{constructor(t){this.model=t}display(){return w(this,void 0,void 0,(function*(){return`\n            <h1> Key </h1>\n            <button id="refresh-key">Refresh</button>\n            <p> ${yield this.model.getKey()} </p>\n        `}))}}var k=function(t,e,n,i){return new(n||(n=Promise))((function(o,r){function s(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))};var b=function(t,e,n,i){return new(n||(n=Promise))((function(o,r){function s(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))};class x{constructor(t,e){this.model=t,this.view=e,document.addEventListener("input",t=>{let e=t.target;"filter"==e.id&&(this.view.filter=e.value,this.model.resourceManager.notify())})}update(){return b(this,void 0,void 0,(function*(){return yield this.view.display()}))}refreshAndUpdate(){return b(this,void 0,void 0,(function*(){return yield this.model.getBooks().then(t=>this.update())}))}}var M=function(t,e,n,i){return new(n||(n=Promise))((function(o,r){function s(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))};class ${constructor(t,e){this.model=t,this.view=e,document.addEventListener("change",t=>{let e=t.target;"op"==e.id&&(this.model.op=e.value,this.model.resourceManager.notify())}),document.addEventListener("submit",t=>M(this,void 0,void 0,(function*(){t.preventDefault();let e=t=>{let e=document.querySelector(t);return e&&e.value?e.value:""},n={id:e("#id"),op:e("#op"),title:e("#title"),author:e("#author")};yield this.model.submitForm(n).then(()=>{this.model.resourceManager.notify()})})))}update(){this.view.display()}}class P{constructor(t,e){this.model=t,this.view=e}update(){this.view.display()}}class B{constructor(t,e){this.model=t,this.view=e}update(){this.view.display()}}var F=function(t,e,n,i){return new(n||(n=Promise))((function(o,r){function s(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))};let S=new class{constructor(){this.resourceManager=new l,this.keyModel=new u(this.resourceManager),this.formModel=new s(this.resourceManager),this.bookModel=new o(this.resourceManager),this.logBoxModel=new a(this.resourceManager)}};new class{constructor(t,e){this.model=t,this.view=e,this.model.resourceManager.addListener(this),this.bookController=new x(t.bookModel,this.view.bookView),this.formController=new $(t.formModel,this.view.formView),this.logBoxController=new P(t.logBoxModel,this.view.logBoxView),this.keyController=new B(t.keyModel,this.view.keyView),document.addEventListener("click",t=>F(this,void 0,void 0,(function*(){let e=t.target;"#refresh-key"==e.id&&(yield this.model.resourceManager.refreshKey()),"refresh-books"==e.id&&(yield this.bookController.refreshAndUpdate())})))}update(){return F(this,void 0,void 0,(function*(){document.querySelector("#main").innerHTML=yield this.view.display()}))}}(S,new class{constructor(t){this.model=t,this.bookView=new f(t.bookModel),this.formView=new v(t.formModel),this.logBoxView=new m(t.logBoxModel),this.keyView=new g(t.keyModel)}display(){return k(this,void 0,void 0,(function*(){return`\n            <section class="card">\n                <div id="book-form-container">\n                    ${yield this.formView.display()}\n                </div>\n            </section>\n            <section class="cards">\n                <div class="card" id="log-box">\n                    ${yield this.logBoxView.display()}\n                </div>\n                <div class="card" id="key">\n                    ${yield this.keyView.display()}\n                </div>\n            </section>\n            <section id="books" class="cards">\n                ${yield this.bookView.display()}\n            </section>\n        `}))}}(S))}]);
//# sourceMappingURL=main.js.map